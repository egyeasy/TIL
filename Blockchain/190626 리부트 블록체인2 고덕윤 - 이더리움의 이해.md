# 190626 리부트 블록체인 고덕윤 - 이더리움의 이해

# 1. 이더리움 소개

#### 이더리움이란?

분산화된 상태전이 머신

- 트랜잭션에 기반한 상태전이
  - 단 이전 상태로 되돌아갈 수 없음
- 암호화 알고리즘을 활용 -> 무작위로 상태전이가 일어나는 것을 방지
- 모든 참여자가 동일한 상태를 공유
- 블록은 해당 시점의 이더리움의 상태를 나타낸다고 볼 수 있음
  - 현재 블록 -> 현재 이더리움의 상태



#### 이더리움의 구성요소

##### 이더리움 계정의 종류

- 외부 소유 계정(EOA, External Owned Account)
  - ETH 잔액 유지
  - 개인 키를 통한 주소 관리
  - ETH 전송, 컨트랙트 실행을 위한 거래 전송 가능
  - 컨트랙트 코드를 가지고 있지 않음(빈 문자열 hash값)
- 컨트랙트 계정(CA, Contract Account)
  - ETH 잔액 유지
  - 주소를 가지고 있으나 개인키는 존재하지 않음
  - 컨트랙트 코드를 보유
  - 거래나 메시지를 수신하면 보유하고 있는 컨트랙트 코드를 실행

##### 주소 생성

##### 상태(State)

- 어느 한 시점에 대한 Ether의 잔액, 기타 정보를 담고 있는 계정(Account)들의 집합
- 모든 이더리움의 참여 노드는 로컬에 상태 정보를 유지함
- stateObject
  - 상태의 수정이 발생한 이더리움 계정을 나타내는 객체
- stateObject를 통해 이더리움의 state database인 LevelDB에 업데이트



##### 이더리움의 상태 전이(State Transition)

- 블록 채굴로 인한 거래 내역 추가 시 상태 전이 발생
- 상태전이함수에 의해 수행



##### 트랜잭션 종류

- (외부) 트랜잭션
  - EOA가 다른 EOA 혹은 CA로 보내는 '서명된 메시지'
    - EOA -> EOA : ETH 잔액 변경(ETH 송금)
    - EOA -> CA : 컨트랙트 코드 실행
  - 계정의 상태 변화를 유도하는 일종의 트리거
- 내부 트랜잭션
  - CA가 다른 CA 혹은 EOA에게 전달하는 '서명되지 않은 메시지'
  - 주로 컨트랙트 함수 호출에 사용
  - 블록체인에 별도로 저장되지 않음



##### 트랙잭션 리시트(Receipt)

- 트랜잭션 실행결과를 기록



##### 블록

- 이더리움 장부에 기록되는 데이터의 기본 단위
- 트랜잭션들의 집합
- 비트코인의 블록 정보에 엉클해시, 리시트, 블룸, 가스와 같은 정보들이 추가됨



##### 엉클 블록(Uncle Block)

- 동일 시점에 채굴된 블록 중 채굴 난이도가 낮아 메인 체인에 연결되지 못한 블록
- 소모된 연산에 대해 보상이 지급됨



##### 작업증명(PoW)

- Ethash
  - ASIC(전문 채굴기기) 저항성을 높임

##### 지분증명(PoS)

- 검증자가 가진 지분에 비례한 확률로 블록 생성 권한을 획득하고 생성된 블록을 원하는 체인에 연결, 보상 획득 - 많이 가진 사람일수록 악의적인 참여를 할 확률이 낮다는 가정
- PoW의 문제점을 개선
  - 전력 소모량, 채굴 중앙화 등
- 이더리움은 Casper를 통해 PoS로 전환 중



##### Casper FFG(Friendly Finality Gadget)

- PoW + PoS의 하이브리드 방식
- 1~99번째 블록은 PoW, 100번째 블록은 PoS 방식으로 채굴
  - 이 100번째 PoS 블록을 체크포인트라고 정의함
  - 전체 PoS 검증자들 중 2/3 이상이 투표한 블록이며 되돌릴 수 없음 -> Finalize
- 1~100번째 블록을 Epoch라고 정의함
  - 현재는 100개의 블록이 하나의 epoch를 구성
  - 추후 이 epoch의 길이를 축소해가면서 PoS 블록의 비율을 늘릴 예정



## 이더리움 스마트 컨트랙트

- 스마트 컨트랙트 개발 언어
  - Solidity : 현재 가장 많이 사용되고 있는 이더리움 스마트 컨트랙트 언어
  - SERPENT, LLL
- 작동 과정
  1. Solidity 스마트 컨트랙트 작성
  2. 컴파일(solc)
  3. Bytecode, ABI
  4. 이더리움에 bytecode 배포 -> EVM(Ethereum Virtual Machine)
  5. CA 생성, Block에 bytecode 저장
  6. JSON-RPC from JVM to Web3



#### 스마트 컨트랙트의 배포(Deployment)

**가스** - 배포 수수료



#### 스마트 컨트랙트의 실행(Execution)

스마트 컨트랙트의 주소와 내용을 넣고, 가스를 지불하여 실행



#### 가스(Gas)

- 이더리움을 움직이게 하는 '기본 단위' - DDos 등에 의한 무한루프 코드를 방지하고자 도입
- 트랜잭션, 스마트 컨트랙트를 위한 수수료
- 가스 가격의 기본 단위 : Gwei(1 Gwei = 0.000000001 ETH)
  - 이는 사용자가 정의할 수 있으며 단위가 클수록 트랜잭션의 빠른 처리가 가능





## 이더리움의 동작 메커니즘

계정, 트랜잭션의 생성 -> 서명 -> 검증 -> 채굴





# 2. 이더리움 가상 머신

#### Ethereum Virtual Machine

- 이더리움 스마트 컨트랙트를 실행하기 위한 가상머신
- 특징
  - 튜링 완전 머신
  - 이더리움 관련 구조 연산에 최적화
- 모든 동작을 수행하기 위해서는 사전에 가스가 지불되어야 함
- EVM 간 메시지를 통해 데이터를 송수신 가능
- 결정적(Deterministic) 머신 -> 항상 동일한 상태를 반환
- 단일 컴퓨터 -> 전세계의 모든 컴퓨터가 단일한 프로그램을 돌린다(효율성을 희생하여 신뢰를 보장)



#### EVM Stack

- 이더리움의 모든 연산은 스택에서 수행
- 피연산자(데이터), 연산의 임시 값 역시 스택에 저장



#### 기반 동작의 이해

- 입력 값 -> Bytecode
- 입력 값의 종류에 따라 다른 동작을 수행
  - 명령어: 연산 (PUSH, ADD, MUL)



#### EVM memory

- 스마트 컨트랙트 호출 시 생성
- 함수의 매개변수, 지역 변수 및 반환 값 등을 임시적으로 저장
- 일반적인 PC의 RAM과 마찬가지로 휘발성
- EVM 첫 구동 시 크기는 0으로 설정됨
- 메모리를 효율적으로 사용해야 함



#### EVM Storage

- 디스크와 같이 영구적인 데이터 저장소
- 누구나 쉽게 데이터를 저장하고 뺄 수 있음



### EVM 실행모델

#### EVM code : EVM 실행을 위한 입력값

- Bytecode 형태



### 주요 명령어

#### 기본적으로 256비트의 크기를 가짐

- EVM의 모든 명령어는 이더리움 yellow paper에 정의되어 있음

#### CALL 명령어를 통한 EVM 간 메시지 송수신

- EVM은 다른 EOA 혹은 CA에 메시지를 보낼 수 있음

- 데이터 전달 시 EVM의 메모리를 이용하여 함수인자, 반환값을 전달





# 3. 솔리디티 개요

#### 솔리디티란?

- 이더리움 스마트 컨트랙트 언어의 종류 - Java와 유사한 문법

- 특징
  - 객체지향 언어
    - Class == Contract
    - Object instance == EVM에 배포된 스마트 컨트랙트
  - 정적 타입 언어
    - 다음 노드의 주소를 저장하는 자료구조
  - 스택 기반으로 동작하는 EVM 상에서 구동



- 버전업이 지속적으로 진행되고 있음 - 버전 명시가 중요!
- 컨트랙트 이름은 CamelCase로 정의하는 것을 원칙으로 함
- 파일 내 컨트랙트를 상속, 호출, 생성 가능



#### State/Storage variables

- 상태변수 정의 부분(멤버변수)
  - 컨트랙트에 저장할 상태변수들을 정의
- 접근제어 가능
  - 상태변수의 기본 접근제어는 internal(그 외에 public, private, external)



#### Functions

- 함수 정의 부분

  컨트랙트, 외부 컨트랙트, EOA에서 호출할 수 있는 함수를 정의

- 접근제어 가능

  함수의 기본 접근제어자는 public(그 외에 internal, private, external)

- 함수의 종류 - 경제적인 gas 소모를 위해 중요함

  View - 상태를 write하지 않는 함수(gas 소모 X)

  Pure - read/write X

  Fallback - 함수이름, 매개변수, 반환값이 존재하지 않는 함수

  Modifier - 함수의 행위를 변경

  Payable - 이더를 송금해야만 호출 가능한 함수



#### 자료형

- Bool, int8, int16, address(20 byte의 이더리움 주소를 나타냄), string, array, mapping(key-value쌍 자료형), struct