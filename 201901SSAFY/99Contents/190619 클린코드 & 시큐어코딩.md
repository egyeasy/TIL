# 190619 클린코드 & 시큐어코딩



## 1. 클린코드란?

#### 소프트웨어 대가들이 생각하는 클린코드

- 단순하고 직접적이다.

- 특정 목적을 달성하는 방법은 하나만 제공한다.

- 누군가 주의 깊게 짰다는 느낌을 준다.

- 중복 줄이기, 표현력 높이기, 초반부터 간단한 추상화 고려하기

- 코드를 읽어면서 짐작했던 기능을 각 루틴이 그대로 수행한다.

  => 다른 사람이 쉽게 읽을 수 있어야 한다.

  즉, **가독성이 좋아야 한다.**



## 2. 클린코드는 왜 필요할까?

개발시간을 단축할 수 있다.

코드를 읽는 시간 : 코드를 짜는 시간 = 10 : 1



## 3. 클린코드를 만드는 규칙

1. 의미 있는 이름(Naming)
   - 변수, 클래스, 메서드에 의도가 분명한 이름을 사용한다.
   - 잘못된 정보를 전달할 수 있는 이름은 사용하지 않는다.
2. 명확하고 간결하게 주석달기(Comment)
   - 코드를 읽는 사람이 코드를 작성한 사람만큼 코드를 잘 이해할 수 있도록 돕는 것
   - 주석은 반드시 달아야 할 이유가 있는 경우에만 사용 - 보안 이슈 등 유의할 것
   - 설명을 위한 설명을 달지 말 것 - 함수 호출에서 파악할 수 있는 내용을 중복 언급하지 말 것. 함수의 중요한 세부 사항을 주석으로 남기는 것이 좋다.
3. 보기 좋게 배치하고 꾸미기(Aesthetics)
   - 규칙적인 들여쓰기와 줄바꿈으로 가독성 향상
   - 메소드를 이용하여 불규칙한 중복 코드를 제거한다.
   - 가독성 향상에 도움이 된다면 코드의 열을 맞춰라.
   - 코드를 그룹과 계층 구조 방식으로 조작하면 가독성이 향상된다.
   - 코드를 문단으로 나눠서 작성한다.
4. 읽기 쉽게 흐름제어 만들기(Making control flow easy to read)
   - 왼쪽에 변수를 오른쪽에 상수를 두고 비교하라.
   - 부정이 아닌 긍정을 다뤄라.
   - if/else를 사용하고 삼항 연산자는 매우 간단한 경우에만 사용한다.
   - do/while 루프를 피하라. -> 차라리 if + while을 써라
   - 중첩을 최소화하기
   - 설명 변수와 요약 변수를 이용하여 커다란 표현을 작게 만들어라.
     -> 늘여씀으로 인해 퍼포먼스가 줄어드는 정도는 지극히 미약하다.
     -> 수 백만 건이라면 다를 수도 있다. 빅데이터에서는 다른 문제가 된다.
5. 착한 함수(Function)
   - 함수는 가급적 작게, 한번에 하나의 작업만 수행하도록 작성되어야 한다.



## 4. 레거시 코드를 다루기 위한 프렉티스

### 코드리뷰

- 코드리뷰와 리팩토링 - 레거시 코드를 읽기 쉬운 깨끗한 코드로 만드는 방법. 코드리뷰를 통해 냄새나는 코드를 발견하고, 리팩토링을 통해 점진적으로 개선.

- 코드리뷰 체크리스트

  - 숫자를 직접 서술하지 않고 상수를 사용하고 있는가?
  - 주석처리 된 코드를 삭제되었는가?
  - 함수의 길이 - 20줄 이내, 한 라인 당 150자를 넘지 않도록 한다.
  - 전역변수를 최소화했는가? -> 특히 웹 어플리케이션 개발에서 주의. read only로 설정할 것(상수 값)
  - 변수의 범위는 적절하게 선언되었는가? -> 변수의 종류에 따라 수명이 다르다.

  **아래는 정말로 체크해야할 중요한 사항들** -> 치명적인 문제와 연관됨

  - 입력 파라미터의 유효범위는 체크하고 있는가?
  - 오류코드를 반환하는 함수보다 예외(exception)을 적극적으로 활용하고 있는가?
  - try/catch 에러 핸들링 사용방법은 적절하게 구현되었는가?
  - 메서드에서 null을 전달하거나 반환하지 않고 있지는 않은가?
  - switch문에 default가 존재하며, 예외처리하고 있는가?
  - 배열을 사용할 때, index 범위를 체크하는가?
  - 포인트 사용 시에 유효한 범위를 체크하는가?
  - 가비지 컬렉션(garbage collection)은 제대로 수행되고 있는가?
  - 에러 조건이 체크되고 에러 메시지와 에러 코드가 의미를 잘 전달하는가?



## 5. 시큐어코딩이란?

안전한 소프트웨어 - 안전한 SW 개발을 위해 **소스코드 등에 존재할 수 있는 잠재적인 보안약점을 제거**하고, **보안을 고려하여 기능을 설계 구현**하는 등 SW 개발 과정에서 일련의 보안활동을 수행하는 SW개발보안을 적용

보안 약점(Weaknesses) - 소프트웨어에서 해킹 등 실제 보안 사고에 악용될 수 있는 보안 취약점의 근본 원인. cwe.mitre.org에 1천여 개가 보고되어 있음 -> 그 중에서 가장 치명적인 25가지를 꼽은 것이 SANS Top 25
보안 취약점(Vulnerabilities) - 소프트웨어 실행 시점에 여러 개의 보안 약점 중 실제 침해 사고의 원인이 되는 그 보안 약점. 발견된 보안취약점들을 목록화해놓은 사이트가 CVE(cve.mitre.org)

#### 취약점의 일반론

- 사용자(특히 공격자)가 조작할 수 있는 입력 또는 객체를 통해 공격이 수행된다. 즉 신뢰 되지 않는 외부 입력을 그대로 사용하는 것이 중요한 침해사고의 원인이 된다.
- 이제는 보안 담당자뿐만 아니라 개발자들에게도 보안 이슈에 대한 대처가 요구됨.



## 6. 사고사례기반 시큐어코딩의 필요성

#### 여기어때 사고사례(2017)

- SQL인젝션 취약점 - 99만여 명의 고객 개인정보가 탈취됨. SQL인젝션은 SANS Top 25 중 1위의 Worst case

- 관리자 권한 아이디 탈취 -> 웹페이지를 관리자 권한으로 우회 접속(세션변조공격) -> 예약정보, 제휴점 정보 및 회원정보 유출
- 애초에 내부에서만 관리자 권한 접속이 가능하게 했어야 함.
- SQL 인젝션 취약점의 발생 요건 -> 외부에서 들어온 요청이 쿼리를 조작할 수 있을 때.  statement(동적 쿼리), prepared statement(정적 쿼리).
  statement는 **(외부) 입력값**을 먼저 집어넣음 -> 구문 분석 -> 명령어를 만들어서 실행 : **외부 입력값**이 명령어가 될 수 있다. 이것이 사고의 시작점.
  prepared statement는 SQL문을 구문 분석 -> 명령어화 -> 외부 입력값을 매핑 -> 실행(외부 명령을 통해 쿼리 구조를 바꿀 수 없다. - 안전함)



#### 예시 코드

에러를 만든 다음에 에러 메시지로부터 해당 웹사이트에 대한 정보를 얻을 수 있음

```sql
SELECT * FROM users
WHERE id = '' or 'a' = 'a' and password = '' or 'a' = 'a'
```

id : `' or 'a' = 'a` pw : `' or 'a' = 'a`으로 로그인을 시도하여 에러를 유발시킬 수 있다.



too many result -> 하나만 받아오도록 해보자.

회원가입에서 `admin`이라는 id가 이미 존재함을 알 수 있다. admin을 해킹해보자.\

```sql
SELECT * FROM users
WHERE id = 'admin'#나머지 주석처리
```

어떤 것이 취약한 코드 패턴인지 잘 유의해서 짜도록 해보자.



#### KT 개인정보 유출(2014) - 1200만 명

로그인 과정의 '인가' 정책이 잘못되어 있었음.

요금명세서 조회 클릭 -> 고객번호가 함께 파라미터로 요청에 들어감.

하지만 이것이 잘못된 숫자여도 종종 맞는 결과를 반환.

paros라는 proxy 서버에 9자리 숫자를 만들어서 요청하고 null이 아닌 response가 오면 excel파일에 저장.



하루에 수천 수백 만 건의 transaction이 있으므로, 한 세션에서 20-30만 건을 보내도 warning만 한다 -> 장비로는 해결할 수 없다.

id value를 변경해서 보낼 수 있을 것이라는 생각을 하지 않아서 그걸 재검증하는 코드를 넣지 않았음.



#### 예시

paros를 사용하여 회원정보 변경 request를 탈취할 수 있음. 요청의 userid를 admin으로 변경하여 admin의 비밀번호를 바꾸는 시도가 가능.(`userid=admin`) -> admin의 아이디를 얻을 수 있다.

1. 비밀번호 변경 요청시 프레임워크 단에서는 id, old pw, new pw를 하나의 객체에 value들로 담아서 server에 보냄.
2. server는 id와 pw를 db에 조회해서 존재하는 유저인지 검증 -> **이 때 세션의 id를 이용하는 것이 맞음**
3. but 이에 더해 세션의 id와 파라미터의 id가 같은지를 검증해야 안전이 보장됨. 그렇지 않으면 임의로 정한 파라미터 id의 비밀번호가 바뀌게 됨.



#### yes24 URL 파라미터 조작 개인정보 노출(2016)

주문번호만 조금 바꾸면 다른 사람의 주문 정보 조회 가능



### 시큐어코딩과 소프트웨어 개발보안 활동

- 코드 자체와 더불어 아키텍쳐와 같은 전체 구조적인 요인에 의해서도 보안약점이 발생할 수 있다.

- 버그를 줄이면 빈틈을 줄일 수 있고, 보안약점을 줄일 수 있게 된다. -> 시큐어코딩에 있어 클린코딩이 중요

- 시큐어코딩/클린코딩은 습관이다 -> 시간이 없어도 반영할 수 있어야 한다.

  ex) java에서 `if name.equals("홍길동")`은 name이 null일 때 에러를 발생시킴 -> `if("홍길동".equals(name))`

- 인공지능, 블록체인, iOT 서비스 모두 웹 기반으로 움직인다 -> 웹 취약점에 절대 주의할 것





올해는 AI의 시대 / 모든 것을 다 배워간다고 생각하고 시도해볼 것 / 팀 내에서 기술별 리드를 만들어서 모두가 함께 성장하도록 해볼 것

